# metagesToolkit

Repositorio de uso interno para leer, analizar y actualizar el Registro
de Instituciones, colecciones y bases de datos de biodiversidad de GBIF
EspaÃ±a

- [DescripciÃ³n](#descripci%C3%B3n)
- [InstalaciÃ³n](#instalaci%C3%B3n)
- [Uso](#uso)
  - [AÃ±adir credenciales](#a%C3%B1adir-credenciales)
  - [Generar informe](#generar-informe)
  - [Crear mapas](#crear-mapas)
- [Estructura del repositorio](#estructura-del-repositorio)

------------------------------------------------------------------------

## DescripciÃ³n

Este toolkit de uso interno proporciona un conjunto de herramientas en R
y SQL (incluyendo el paquete de R `metagesToolkit`) para gestionar y
analizar `MetaGES`, la base de datos del **[Registro de Colecciones de
GBIF.ES](https://gbif.es/registro-colecciones/)**.

El paquete permite:

- ğŸ” Extraer informaciÃ³n directamente desde la base de datos MetaGES,
- ğŸ“Š Procesar y resumir los datos (incluyendo generaciÃ³n de mapas
  temÃ¡ticos),
- ğŸ“ Producir informes tÃ©cnicos reproducibles en formato Word.

El paquete asume un entorno de trabajo controlado y acceso autorizado a
MetaGES. No estÃ¡ pensado como paquete de uso general.

------------------------------------------------------------------------

## InstalaciÃ³n

El paquete se instala directamente desde GitHub:

``` r
# install.packages("remotes")
remotes::install_github("GBIFes/metages-toolkit")

# Para desarrollo local del paquete se recomienda utilizar `devtools`, pero no es necesario para su uso normal.
# install.packages("devtools")
# devtools::install_github("GBIFes/metages-toolkit")
```

------------------------------------------------------------------------

## Uso

Actualmente, el flujo principal del paquete se articula en torno a la
funciÃ³n
[`render_informe()`](https://gbifes.github.io/metages-toolkit/reference/render_informe.md),
que orquesta internamente la conexiÃ³n a MetaGES, la extracciÃ³n de datos,
el procesamiento, la creaciÃ³n de mapas y la generaciÃ³n de un informe
final como archivo `.docx`.

El paquete expone ademÃ¡s dos funciones Ãºtiles para la exploraciÃ³n
[`crear_mapa_simple()`](https://gbifes.github.io/metages-toolkit/reference/crear_mapa_simple.md)
y el post-procesado del informe
[`insertar_tabla_colecciones()`](https://gbifes.github.io/metages-toolkit/reference/insertar_tabla_colecciones.md).
Sin embargo, para usar estas funciones ***es imprescindible tener
credenciales para acceder a MetaGES:***  
  

##### âš ï¸AÃ±adir credenciales:âš ï¸

Para extraer datos de MetaGES es necesario tener acceso a la Base de
Datos. Los siguientes variables de entorno deben estar definidas en el
archivo `.Renviron` antes de usar el paquete; y se cargarÃ¡n
automÃ¡ticamente al iniciar una sesiÃ³n de R:

- `host_prod`
- `keyfile`
- `prod_ssh_bridge_R`
- `Database`
- `UID`
- `gbif_wp_pass`

**[Instrucciones para editar y guardar
credenciales](https://github.com/GBIFes/metages-toolkit/blob/main/inst/scripts/actualizar_Renviron.R)**

------------------------------------------------------------------------

### Generar informe

Genera un archivo `.docx` en el `working directory` actual basado en
[Informe
Quarto](https://github.com/GBIFes/metages-toolkit/blob/main/inst/reports/informe.qmd).  
El informe contiene informaciÃ³n detallada sobre el contenido de la base
de datos MetaGES

``` r
# FunciÃ³n principal del paquete. Ejecuta el flujo completo de trabajo: conexiÃ³n a MetaGES, extracciÃ³n y procesamiento de datos, generaciÃ³n de mapas y renderizado del informe base.
# Genera `informe.docx`
render_informe()      

# FunciÃ³n de post-procesado que aÃ±ade tablas adicionales al documento generado por `render_informe()`.
# Genera `informe_con_tablas_colecciones.docx`. `keyword` debe coincidir con una SecciÃ³n existente de informe.docx. 
insertar_tabla_colecciones(keyword = "Anexo X") 
```

------------------------------------------------------------------------

### Crear mapas

Genera un mapa a partir de los datos procesados.  
Permite filtrar por `tipo_coleccion`, `disciplina`, `subdisciplina` y si
`publican` en GBIF o no. AdemÃ¡s, permite hacer un `facet` con cualquier
columna de la tabla de datos.

ğŸ‘‰ **Consulta el artÃ­culo [CreaciÃ³n de mapas de colecciones con
metagesToolkit](https://gbifes.github.io/metages-toolkit/articles/crear-mapas.html)**

- ***Mapa de las colecciones de invertebrados publicadoras***

``` r
crear_mapa_simple(tipo_coleccion = "coleccion",
                          subdisciplina = "Invertebrados", 
                          publican = TRUE)$plot
```

![](reference/figures/mapa-colecciones-inv-pub.png)

- ***Mapa de las bases de datos publicadoras faceteado por disciplina***

``` r
crear_mapa_simple(tipo_coleccion = "base de datos",
                          facet = "disciplina_def",
                          publican = TRUE)$plot                       
```

![](reference/figures/mapa-facet-bd-disciplina-pub.png)

------------------------------------------------------------------------

## Estructura del repositorio

El repositorio combina cÃ³digo del paquete R con recursos auxiliares
necesarios para la exploraciÃ³n de MetaGES y para la generaciÃ³n del
informe.

    metages-toolkit/
    â”œâ”€â”€ codecov.yml
    â”œâ”€â”€ DESCRIPTION                                     : DescripciÃ³n del paquete de R metagesToolkit.
    â”œâ”€â”€ inst/
    â”‚   â”œâ”€â”€ reports/                                    : Materiales para generar el informe de colecciones.
    â”‚   â”‚   â”œâ”€â”€ assets/                                 : ImÃ¡genes y plantillas para el informe.
    â”‚   â”‚   â”‚   â”œâ”€â”€ images/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ external/
    â”‚   â”‚   â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ generated/                      : Contiene imagenes autogeneradas por inst/scripts/actualizar_mapas_vignettes.R para ser usadas por informe.qmd
    â”‚   â”‚   â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ logos/
    â”‚   â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   â””â”€â”€ templates/
    â”‚   â”‚   â”‚       â””â”€â”€ reference.docx
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ data/                                   : Contiene carpetas autogeneradas por inst/scripts/actualizar_mapas_vignettes.R
    â”‚   â”‚   â”‚   â”œâ”€â”€ mapas/                              : Contiene objetos .rds con la tabla de datos que genera cada mapa del informe y las vignettes
    â”‚   â”‚   â”‚   â””â”€â”€ vistas_sql/                         : Contiene objetos .rds con la tabla de datos que genera cada vista SQL de MetaGES
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â”€ informe.qmd                             : Documento Quarto que genera el informe de colecciones usando las funciones del paquete de R metagesToolkit.
    â”‚   â””â”€â”€ scripts/                                    : R Scripts de apoyo a la gestiÃ³n de la base de datos MetaGES, del paquete de R metagesToolkit y para almacenar funciones que aun no han sido aÃ±adidas al paquete de R.
    â”‚       â”œâ”€â”€ actualizar_SQL_scripts.R
    â”‚       â”œâ”€â”€ actualizar_Renviron.R
    â”‚       â”œâ”€â”€ usage.R
    â”‚       â”œâ”€â”€ ...
    â”‚
    â”œâ”€â”€ LICENSE                                         : Licencia de uso del repositorio.
    â”œâ”€â”€ man/                                            : DocumentaciÃ³n de las funciones del paquete de R.
    â”‚
    â”œâ”€â”€ metagesToolkit.Rproj                            : Archivo del proyecto de RStudio.
    â”œâ”€â”€ NAMESPACE                                       : Define que dependencias se importan y exportan al usar el paquete de R.
    â”œâ”€â”€ R/                                              : Funciones que forman parte del paquete de R.
    â”‚   â”œâ”€â”€ conectar_metages.R                          : FunciÃ³n para conectar R a MetaGES
    â”‚   â”œâ”€â”€ extraer_colecciones_mapa.R                  : FunciÃ³n para extraer datos de colecciones de MetaGES. Usa conectar_metages.R
    â”‚   â”œâ”€â”€ crear_mapa.R                                : Funcion compleja para crear mapas con los datos de extraer_colecciones_mapa.R
    â”‚   â”œâ”€â”€ crear_mapa_simple.R                         : Wrapper simplificado de crear_mapa.R. OpciÃ³n recomendada para crear mapas.
    â”‚   â”œâ”€â”€ render_informe.R                            : Crea una carpeta con el contenido del output de informe.qmd
    â”‚   â”œâ”€â”€ insertar_tabla_colecciones.R                : AÃ±ade la gran tabla final al output de render_informe.R, generando informe_con_tablas_colecciones.docx
    â”‚   â”œâ”€â”€ ...
    â”‚
    â”œâ”€â”€ README.md                                       : DescripciÃ³n del repositorio.
    â”œâ”€â”€ sql/                                            : Scripts generados automaticamente por actualizar_SQL_scripts.R para guardar la documentacion de las Vistas y otros Scripts de MetaGES.
    â”‚   â”œâ”€â”€ LEEME
    â”‚   â””â”€â”€ scripts/
    â”‚       â”œâ”€â”€ colecciones_per_estado_publicacion.sql
    â”‚       â”œâ”€â”€ colecciones_informatizacion_ejemplares.sql
    â”‚       â”œâ”€â”€ colecciones_per_anno.sql
    â”‚       â”œâ”€â”€ contactos_entidades.sql
    â”‚       â”œâ”€â”€ ...
    â”‚
    â”œâ”€â”€ vignettes/
    â”‚   â””â”€â”€ crear-mapas.Rmd                             : Markdown para crear un articulo en github pages (https://gbifes.github.io/metages-toolkit/articles/crear-mapas.html)
    â”‚
    â”œâ”€â”€ docs/                                           : Documentos necesarios para crear la github page del repo (https://gbifes.github.io/metages-toolkit/index.html)
    â”‚
    â”œâ”€â”€ pkgdown/
    â”‚   â””â”€â”€ assets/pkgnet-report.hmtl                   : AnÃ¡lisis de la arquitectura de metagesToolkit realizado por inst/scripts/actualizar_pkgnet_arquitectura.R
    â”‚
    â””â”€â”€ tests/                                          : Tests para las funciones del paquete de R metagesToolkit
        â”œâ”€â”€ testthat/
        â”‚
        â””â”€â”€ testthat.R

# Package index

## Conectar a MetaGES y extraer datos

- [`conectar_metages()`](https://gbifes.github.io/metages-toolkit/reference/conectar_metages.md)
  : Conectar con la base de datos METAGES
- [`extraer_colecciones_mapa()`](https://gbifes.github.io/metages-toolkit/reference/extraer_colecciones_mapa.md)
  : Extraer colecciones desde METAGES para mapas

## Crear mapas y graficos

- [`crear_mapa()`](https://gbifes.github.io/metages-toolkit/reference/crear_mapa.md)
  : Crear mapa de colecciones METAGES
- [`crear_mapa_simple()`](https://gbifes.github.io/metages-toolkit/reference/crear_mapa_simple.md)
  : Mapa METAGES (version simple para uso)
- [`crear_mapa_entidades()`](https://gbifes.github.io/metages-toolkit/reference/crear_mapa_entidades.md)
  : Crear mapa de entidades en el Registro facetado segun publicacion en
  GBIF
- [`get_basemap_es()`](https://gbifes.github.io/metages-toolkit/reference/get_basemap_es.md)
  : Obtener basemap de EspaÃ±a (con Canarias desplazadas)
- [`crear_barplot_top_colecciones_pub()`](https://gbifes.github.io/metages-toolkit/reference/crear_barplot_top_colecciones_pub.md)
  : Crear grafico de top colecciones por nÃºmero de registros

## Crear y modificar Informe

- [`render_informe()`](https://gbifes.github.io/metages-toolkit/reference/render_informe.md)
  : Renderiza el informe METAGES
- [`insertar_tabla_colecciones()`](https://gbifes.github.io/metages-toolkit/reference/insertar_tabla_colecciones.md)
  : Inserta la tabla de colecciones en el informe Word

## Extraer datos externos a MetaGES

- [`get_top10_countries_rgbif()`](https://gbifes.github.io/metages-toolkit/reference/get_top10_countries_rgbif.md)
  : Top 10 paises con mayor numero de registros en GBIF
- [`get_top_publishing_countries_gbif()`](https://gbifes.github.io/metages-toolkit/reference/get_top_publishing_countries_gbif.md)
  : Top paises publicadores de datos en GBIF

# Articles

### All vignettes

- [Guia de uso de metagesToolkit â€”
  USUARIOS](https://gbifes.github.io/metages-toolkit/articles/guia-uso-usr.md):
- [Guia de uso de metages-toolkit â€”
  DESARROLLADORES](https://gbifes.github.io/metages-toolkit/articles/guia-uso-dev.md):
- [GeneraciÃ³n de mapas con
  crear_mapa_simple()](https://gbifes.github.io/metages-toolkit/articles/crear-mapas.md):
